<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- ===== 기본 문서 설정 ===== -->
  <!-- 문서 문자 인코딩 설정 (UTF-8로 한글 지원) -->
  <meta charset="UTF-8">
  <!-- 반응형 웹 디자인을 위한 뷰포트 설정 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 리퍼러 정책 설정 - 외부 사이트로 이동할 때 URL 정보 전송 방식 -->
  <meta name="referrer" content="no-referrer-when-downgrade">
  <!-- 보안 정책 설정 - HTTP 요청을 HTTPS로 자동 업그레이드 -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <!-- 캐시 제어 설정 - 브라우저 캐시 사용 안 함 (개발용) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- 기본 URL 경로 설정 -->
  <base href="./">
  <!-- 브라우저 탭에 표시될 페이지 제목 -->
  <title>ZAVIS</title>
  <!-- 버전 정보 주석 (배포 버전 추적용) -->
  <!-- Updated for docs folder v2.1 -->
  
  <!-- ===== PWA (Progressive Web App) 설정 ===== -->
  <!-- PWA 매니페스트 파일 연결 (앱처럼 사용할 수 있도록 설정) -->
  <link rel="manifest" href="manifest.json?v=2">
  
  <!-- PWA 메타 태그들 -->
  <!-- 앱 테마 색상 설정 (상태바 색상 등에 사용) -->
  <meta name="theme-color" content="#f5ecd7">
  <!-- iOS Safari에서 웹앱 모드 활성화 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- iOS Safari 상태바 스타일 설정 -->
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <!-- iOS 홈화면에 추가될 때 표시되는 앱 이름 -->
  <meta name="apple-mobile-web-app-title" content="ZAVIS">
  <!-- iOS 홈화면 아이콘 설정 -->
  <link rel="apple-touch-icon" href="mp1.png?v=2">
  
  <!-- ===== 외부 리소스 로드 ===== -->
  <!-- 넥슨고딕 웹폰트 CDN 로드 - 일관된 한글 폰트 적용 -->
  <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2107@1.1/NEXON_Gothic.css" rel="stylesheet" type="text/css" />
  
  <!-- 수파베이스 라이브러리 로드 - 데이터베이스 연결 및 인증 기능 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      overflow-x: hidden;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'NEXON Gothic', sans-serif;
      background: #f5ecd7; /* 베이지 */
      color: #222;
      min-height: 100vh;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      padding: 20px 20px 0 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }
    .title {
      font-size: 3.5rem;
      font-weight: bold;
      margin-bottom: 24px;
      letter-spacing: 3px;
      text-align: center;
      word-break: keep-all;
    }
    .compass {
      width: 180px;
      max-width: 70vw;
      margin-bottom: 28px;
      display: block;
    }
    .desc {
      font-size: 1.1rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 32px;
      line-height: 1.7;
      letter-spacing: -1px;
      width: 100%;
      word-break: keep-all;
    }
    .desc span {
      display: block;
      margin-bottom: 4px;
    }
    .ask-btn {
      width: 50%;
      max-width: 280px;
      min-width: 200px;
      padding: 16px 12px;
      font-size: 1.1rem;
      font-family: inherit;
      font-weight: bold;
      background: #fffbe9;
      border: 2px solid #e0cfa9;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: background 0.2s, border 0.2s;
      text-align: center;
      word-break: keep-all;
    }
    .ask-btn:hover {
      background: #f7efd2;
      border-color: #d6b98c;
    }
    
    .auth-section {
      margin-top: 32px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    
    .auth-buttons {
      display: flex;
      gap: 12px;
      width: 100%;
      max-width: 280px;
      justify-content: center;
    }
    
    .auth-btn {
      flex: 1;
      padding: 14px 12px;
      font-size: 1rem;
      font-family: inherit;
      font-weight: bold;
      background: #fffbe9;
      border: 2px solid #e0cfa9;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: background 0.2s, border 0.2s;
      text-align: center;
      text-decoration: none;
      color: #222;
      display: inline-block;
    }
    
    .auth-btn:hover {
      background: #f7efd2;
      border-color: #d6b98c;
    }
    
    .user-info {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.3);
      border-radius: 12px;
      margin-top: 16px;
    }
    
    .user-name {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    
    .user-stats {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 12px;
    }
    
    .logout-btn {
      padding: 8px 16px;
      font-size: 0.9rem;
      font-family: inherit;
      font-weight: bold;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      color: #666;
    }
    
    .logout-btn:hover {
      background: #f5f5f5;
    }
    @media (max-width: 500px) {
      body {
        padding: 0;
        min-height: 100vh;
        height: 100vh;
        justify-content: center;
        overflow-x: hidden;
      }
      .container {
        padding: 16px 16px 0 16px;
        min-height: 80vh;
        justify-content: center;
        max-width: 95vw;
      }
      .title { 
        font-size: 2.5rem; 
        letter-spacing: 1px;
        margin-bottom: 20px;
      }
      .compass { 
        width: 120px; 
        max-width: 60vw; 
      }
      .desc { 
        font-size: 1rem; 
        letter-spacing: 0px;
      }
      .ask-btn { 
        font-size: 1rem; 
        padding: 12px 8px;
        width: 70%;
        min-width: 180px;
        max-width: 250px;
      }
      
      .auth-buttons {
        flex-direction: column;
        gap: 12px;
        max-width: 250px;
      }
      
      .auth-btn {
        width: 100%;
        padding: 12px;
        font-size: 0.9rem;
      }
    }
    @media (max-width: 350px) {
      .title {
        font-size: 2rem;
        letter-spacing: 0px;
      }
      .ask-btn {
        width: 80%;
        min-width: 160px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">ZAVIS</div>
    <img src="mp1.png" alt="나침반" class="compass" />
    <div class="desc">
      <span>사장님의 수퍼앱</span>
      <span>통찰적인 조언자</span>
      <span>의사결정 나침반</span>
    </div>
    <!-- 질문주세요 버튼 - 로그인 확인 기능 포함 -->
    <button 
        id="askBtn" 
        class="ask-btn" 
        onclick="handleAskButtonClick()"
        style="color: black;">질문주세요, 'Click!'</button>
    
    <!-- 로그인/회원가입 섹션 -->
    <div class="auth-section">
      <!-- 로딩 상태 표시 -->
      <div id="authLoading" style="display: block; text-align: center; padding: 20px;">
        <div style="font-size: 0.9rem; color: #666;">로딩 중...</div>
      </div>
      
      <!-- 로그인되지 않은 상태에서 보여질 버튼들 -->
      <div id="authButtons" class="auth-buttons" style="display: none;">
        <a href="login.html" class="auth-btn">로그인</a>
        <a href="signup.html" class="auth-btn">회원가입</a>
      </div>
      
      <!-- 로그인된 상태에서 보여질 사용자 정보 -->
      <div id="userInfo" class="user-info" style="display: none;">
        <div class="user-name" id="userName">사용자님</div>
        <div class="user-stats" id="userStats">방문횟수: 0회</div>
        <button class="logout-btn" id="logoutBtn">로그아웃</button>
      </div>
    </div>
    
    </div>

  <!-- ===== 외부 스크립트 파일 로드 ===== -->
  <!-- 수파베이스 설정 및 인증 스크립트 -->
  <!-- 수파베이스 설정 파일 로드 -->
  <script src="config.js"></script>
  <!-- 인증 관련 함수 파일 로드 -->
  <script src="auth.js"></script>
  
  <!-- ===== 서비스 워커 등록 스크립트 ===== -->
  <script>
    // ============================================================================
    // PWA 서비스 워커 관리 함수들
    // ============================================================================
    
    // 캐시 클리어 함수 (필요시에만 사용)
    // 브라우저에 저장된 모든 캐시를 삭제하여 최신 버전으로 업데이트
    async function clearAllCaches() {
      // 브라우저가 캐시 API를 지원하는지 확인
      if ('caches' in window) {
        try {
          // 모든 캐시 이름 가져오기
          const cacheNames = await caches.keys();
          // 각 캐시를 삭제 (병렬 처리)
          await Promise.all(
            cacheNames.map(cacheName => {
              console.log('Deleting cache:', cacheName);
              return caches.delete(cacheName);  // 캐시 삭제
            })
          );
          console.log('All caches cleared successfully');
        } catch (error) {
          console.error('Cache clearing failed:', error);
        }
      }
    }

    // Service Worker 안정적 등록 함수
    // 깜빡거림을 방지하기 위해 재등록 로직을 최소화
    async function registerServiceWorker() {
      // 브라우저가 서비스 워커를 지원하는지 확인
      if ('serviceWorker' in navigator) {
        try {
          // 기존 등록 확인
          const existingRegistration = await navigator.serviceWorker.getRegistration();
          
          if (existingRegistration) {
            console.log('Service Worker already registered');
            return; // 이미 등록되어 있으면 추가 작업 안 함
          }
          
          // 서비스 워커 등록 (깜빡거림 방지를 위해 간단하게)
          const registration = await navigator.serviceWorker.register('./sw.js', {
            scope: './'
          });
          
          console.log('Service Worker registered successfully');
          
          // 업데이트가 있는 경우에만 처리
          registration.addEventListener('updatefound', () => {
            console.log('Service Worker update found');
            // 새 버전이 설치되면 사용자에게 알림 (자동 새로고침 하지 않음)
            if (registration.installing) {
              registration.installing.addEventListener('statechange', (e) => {
                if (e.target.state === 'activated') {
                  console.log('New Service Worker activated');
                  // 사용자에게 선택권 제공 (강제 새로고침 안 함)
                  // alert('새 버전이 업데이트되었습니다. 페이지를 새로고침하시겠습니까?');
                }
              });
            }
          });
          
        } catch (error) {
          // 서비스 워커 등록 실패 시 오류 출력
          console.log('Service Worker registration failed:', error);
        }
      }
    }

    // ============================================================================
    // 페이지 초기화 및 이벤트 리스너
    // ============================================================================
    
    // 초기화 중복 방지 플래그
    let isInitialized = false;
    
    // 초기화 함수 (중복 실행 방지)
    function initializeApp() {
      if (isInitialized) return;
      isInitialized = true;
      
      console.log('앱 초기화 시작');
      
      // 버전 체크용 로컬스토리지
      const currentVersion = '2.1';
      const storedVersion = localStorage.getItem('zavis-version');
      
      if (storedVersion !== currentVersion) {
        localStorage.setItem('zavis-version', currentVersion);
      }
      
      // 서비스 워커 안정적 등록
      registerServiceWorker();
      
      // 모바일 환경에서 안정적인 인증 상태 확인
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const delay = isMobile ? 500 : 300;  // 모바일: 1초→0.5초, 데스크톱: 0.5초→0.3초로 단축
      
      setTimeout(() => {
        stableAuthCheck();
        
        // 모바일 환경에서 1.5초 후에도 로딩 상태면 강제로 로그인 버튼 표시
        if (isMobile) {
          setTimeout(() => {
            const authLoading = document.getElementById('authLoading');
            if (authLoading && authLoading.style.display !== 'none') {
              console.log('모바일 환경: 타임아웃으로 인한 강제 로그인 버튼 표시');
              showAuthButtons();
            }
          }, 1500);  // 5초 → 1.5초로 단축
        }
      }, delay);
    }
    
    // 페이지 로드시 실행 (두 가지 이벤트 모두 사용)
    // DOM 로드 완료 시 (모바일 환경에서 더 빠른 초기화)
    document.addEventListener('DOMContentLoaded', initializeApp);
    
    // 모든 리소스 로드 완료 시 (백업용)
    window.addEventListener('load', () => {
      // 이미 초기화가 완료되었다면 건너뛰기
      initializeApp();
      
      // 추가 안전장치: 모바일에서 1초 후에도 로딩 상태면 강제로 로그인 버튼 표시
      setTimeout(() => {
        const authLoading = document.getElementById('authLoading');
        if (authLoading && authLoading.style.display !== 'none') {
          console.log('window.load 이벤트: 추가 안전장치로 로그인 버튼 표시');
          showAuthButtons();
        }
      }, 1000);  // 2초 → 1초로 단축
    });
    
    // 모바일 환경에서 페이지 포커스 시 추가 체크
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        // 페이지가 다시 보이게 되었을 때 로딩 상태 확인
        setTimeout(() => {
          const authLoading = document.getElementById('authLoading');
          if (authLoading && authLoading.style.display !== 'none') {
            console.log('페이지 포커스 이벤트: 로딩 상태 제거 및 로그인 버튼 표시');
            showAuthButtons();
          }
        }, 500);  // 1초 → 0.5초로 단축
      }
    });
    
    // ============================================================================
    // 안정적인 인증 확인 시스템 (로그인 문제 해결)
    // ============================================================================
    
    // 중복 인증 확인 방지용 플래그
    let authChecked = false;
    
    // 안정적인 인증 확인 함수
    // 로컬 스토리지와 수파베이스 세션을 순차적으로 확인하여 로그인 상태 결정
    async function stableAuthCheck() {
      // 이미 인증 확인이 완료된 경우 중복 실행 방지
      if (authChecked) {
        return;
      }
      
      // 인증 확인 플래그 설정
      authChecked = true;
      
      try {
        // 인증 상태 확인 시작
        
        // 0. URL에서 인증 토큰 확인 (이메일 인증 직후)
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        // 인증 관련 파라미터가 있는지 확인
        const hasAuthParams = urlParams.has('access_token') || 
                             hashParams.has('access_token') || 
                             urlParams.has('error') || 
                             hashParams.has('error');
        
        if (hasAuthParams) {
          // URL 파라미터 정리 (보안 및 깔끔한 URL 유지)
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Supabase가 자동으로 세션을 처리할 시간을 줌
          await new Promise(resolve => setTimeout(resolve, 500));  // 1초 → 0.5초로 단축
        }
        
        // 1. 로컬 스토리지에서 사용자 정보 확인
        // 빠른 로딩을 위해 로컬 스토리지에 저장된 사용자 정보를 먼저 확인
        const savedUserInfo = localStorage.getItem('zavis-user-info');
        
        if (savedUserInfo) {
          try {
            // 저장된 사용자 정보를 JSON으로 파싱
            const userInfo = JSON.parse(savedUserInfo);
            showUserInfo(userInfo);  // 사용자 정보 표시
            return;                  // 로컬 정보가 있으면 즉시 반환
          } catch (e) {
            // JSON 파싱 오류 발생 시 손상된 데이터 제거
            localStorage.removeItem('zavis-user-info');
          }
        }
        
        // 2. 수파베이스 클라이언트 대기 (모바일 환경 최적화)
        // config.js에서 초기화되는 수파베이스 클라이언트가 준비될 때까지 대기
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const maxRetries = isMobile ? 15 : 8;  // 모바일: 3초, 데스크톱: 1.6초 (로그인 문제 해결을 위해 증가)
        const retryDelay = isMobile ? 200 : 100;  // 모바일: 200ms, 데스크톱: 100ms
        
        console.log(`모바일 환경: ${isMobile}, 최대 재시도: ${maxRetries}회`);
        
        let retryCount = 0;
        while (!supabaseClient && retryCount < maxRetries) {
          console.log(`Supabase 클라이언트 대기 중... (${retryCount + 1}/${maxRetries})`);
          await new Promise(resolve => setTimeout(resolve, retryDelay));
          retryCount++;
        }
        
        // 수파베이스 클라이언트 초기화 실패 시 로그인 버튼 표시
        if (!supabaseClient) {
          console.log('수파베이스 클라이언트 초기화 실패 - 로그인 버튼 표시');
          showAuthButtons();
          return;
        }
        
        // 3. 수파베이스에서 현재 로그인된 사용자 정보 확인
        // 로컬 스토리지에 정보가 없거나 수파베이스 세션 확인이 필요한 경우
        
        // getSession 함수로 현재 세션 정보 가져오기
        const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
        
        // 세션 오류 발생 시 로그 출력
        if (sessionError) {
          console.error('세션 확인 오류:', sessionError);
          showAuthButtons();  // 로그인 버튼 표시
          return;            // 함수 종료
        }
        
        // 세션이 있고 사용자 정보가 있는 경우
        if (sessionData.session && sessionData.session.user) {
          
          // 프로필 정보 가져오기
          const { data: profileData, error: profileError } = await supabaseClient
            .from('profiles')                               // profiles 테이블에서
            .select('*')                                   // 모든 컬럼 선택
            .eq('user_id', sessionData.session.user.id)    // 현재 사용자의 프로필
            .single();                                     // 단일 레코드 반환
          
          if (profileData) {
            // 프로필 정보가 있는 경우
            const userInfo = {
              name: profileData.name,
              email: profileData.email,
              visit_count: profileData.visit_count || 1
            };
            
            // 로컬 스토리지에 저장 (다음 방문 시 빠른 로딩)
            localStorage.setItem('zavis-user-info', JSON.stringify(userInfo));
            
            // 사용자 정보 표시
            showUserInfo(userInfo);
            
            // 이메일 인증 직후인 경우 환영 메시지 표시
            if (hasAuthParams) {
              alert(`🎉 이메일 인증이 완료되었습니다!\n\n환영합니다, ${userInfo.name}님!\nZAVIS와 함께 성공적인 비즈니스를 시작해보세요.`);
            }
          } else if (!profileError || profileError.code === 'PGRST116') {
            // 프로필이 없는 경우 생성 시도
            
            // 사용자 메타데이터에서 정보 가져오기
            const metadata = currentUser.user_metadata || {};
            
            // 새 프로필 생성
            const { data: newProfile, error: createError } = await supabaseClient
              .from('profiles')
              .insert([{
                user_id: currentUser.id,
                name: metadata.name || currentUser.email.split('@')[0] || '사용자',
                email: currentUser.email,
                phone: metadata.phone || '',
                visit_count: 1,
                created_at: new Date().toISOString()
              }])
              .select()
              .single();
            
            if (newProfile) {
              const userInfo = {
                name: newProfile.name,
                email: newProfile.email,
                visit_count: 1
              };
              
              // 로컬 스토리지에 저장
              localStorage.setItem('zavis-user-info', JSON.stringify(userInfo));
              
              // 사용자 정보 표시
              showUserInfo(userInfo);
              
              // 환영 메시지
              if (hasAuthParams) {
                alert(`🎉 이메일 인증이 완료되었습니다!\n\n환영합니다, ${userInfo.name}님!\nZAVIS와 함께 성공적인 비즈니스를 시작해보세요.`);
              }
            } else {
              console.error('프로필 생성 실패:', createError);
              // 프로필 생성 실패해도 기본 정보로 표시
              const userInfo = {
                name: currentUser.email.split('@')[0],
                email: currentUser.email,
                visit_count: 1
              };
              showUserInfo(userInfo);
            }
          } else {
            // 다른 프로필 오류
            console.error('프로필 조회 오류:', profileError);
            showAuthButtons();  // 로그인 버튼 표시
          }
        }
        
      } catch (error) {
        // 인증 확인 과정에서 발생한 오류를 콘솔에 출력
        console.error('인증 확인 오류:', error);
        
        // 모바일 환경에서 확실히 로그인 버튼 표시
        setTimeout(() => {
          showAuthButtons();  // 오류 발생 시 로그인 버튼 표시
        }, 100);
      } finally {
        // 최종적으로 로딩 상태가 남아있다면 제거 (모바일에서 더 오래 대기)
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const finalTimeout = isMobile ? 2000 : 1200;  // 모바일: 2초, 데스크톱: 1.2초
        
        setTimeout(() => {
          const authLoading = document.getElementById('authLoading');
          if (authLoading && authLoading.style.display !== 'none') {
            console.log('최종 안전장치: 로딩 상태 제거 및 로그인 버튼 표시');
            showAuthButtons();
          }
        }, finalTimeout);
      }
    }
    
    // ============================================================================
    // UI 업데이트 함수들
    // ============================================================================
    
    // 로그인 버튼 표시 함수
    // 로그인되지 않은 상태에서 로그인/회원가입 버튼을 표시
    function showAuthButtons() {
      // 각 UI 요소를 ID로 선택
      const authLoading = document.getElementById('authLoading');   // 로딩 표시 요소
      const authButtons = document.getElementById('authButtons');   // 로그인/회원가입 버튼 그룹
      const userInfo = document.getElementById('userInfo');         // 사용자 정보 표시 요소
      
      // 모바일 환경에서 더 확실하게 UI 업데이트
      requestAnimationFrame(() => {
        // 로딩 화면 숨기기
        if (authLoading) {
          authLoading.style.display = 'none';
          authLoading.style.visibility = 'hidden';
        }
        
        // 로그인/회원가입 버튼 표시
        if (authButtons) {
          authButtons.style.display = 'flex';
          authButtons.style.visibility = 'visible';
        }
        
        // 사용자 정보 영역 숨기기
        if (userInfo) {
          userInfo.style.display = 'none';
          userInfo.style.visibility = 'hidden';
        }
        
        console.log('로그인 버튼 표시 완료');
      });
    }
    
    // 사용자 정보 표시 함수
    // 로그인된 상태에서 사용자 이름과 방문횟수를 표시
    function showUserInfo(profile) {
      // 각 UI 요소를 ID로 선택
      const authLoading = document.getElementById('authLoading');   // 로딩 표시 요소
      const authButtons = document.getElementById('authButtons');   // 로그인/회원가입 버튼 그룹
      const userInfo = document.getElementById('userInfo');         // 사용자 정보 표시 요소
      const userName = document.getElementById('userName');         // 사용자 이름 표시 요소
      const userStats = document.getElementById('userStats');       // 방문횟수 표시 요소
      
      // 모바일 환경에서 더 확실하게 UI 업데이트
      requestAnimationFrame(() => {
        // 로딩 화면 숨기기
        if (authLoading) {
          authLoading.style.display = 'none';
          authLoading.style.visibility = 'hidden';
        }
        
        // 로그인/회원가입 버튼 숨기기
        if (authButtons) {
          authButtons.style.display = 'none';
          authButtons.style.visibility = 'hidden';
        }
        
        // 사용자 정보 영역 표시
        if (userInfo) {
          userInfo.style.display = 'block';
          userInfo.style.visibility = 'visible';
        }
        
        // 사용자 이름 표시 (이름이 없으면 이메일 표시)
        if (userName) userName.textContent = profile.name || profile.email;
        // 방문횟수 표시 (없으면 0회로 표시)
        if (userStats) userStats.textContent = `방문횟수: ${profile.visit_count || 0}회`;
        
        console.log('사용자 정보 표시 완료');
      });
    }
    
    // ============================================================================
    // 질문주세요 버튼 로그인 확인 함수
    // ============================================================================
    
    // 질문주세요 버튼 클릭 시 로그인 상태 확인 후 처리
    async function handleAskButtonClick() {
      try {
        // 1. 로컬 스토리지에서 사용자 정보 확인 (빠른 확인)
        const savedUserInfo = localStorage.getItem('zavis-user-info');
        
                 if (savedUserInfo) {
           // 로컬에 사용자 정보가 있으면 로그인된 것으로 간주하고 서비스로 이동
           window.open('https://chat.openai.com/g/g-684f6e6b9ed48191bb537979053a36cc-naeireumeun-zavis-sajangnimyi-supeoaeb', '_blank', 'noopener,noreferrer');
           return;
         }
         
         // 2. 수파베이스 세션 확인 (보조 확인)
         if (supabaseClient) {
           const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
           
           if (!sessionError && sessionData.session && sessionData.session.user) {
             // 수파베이스 세션이 있으면 로그인된 것으로 간주하고 서비스로 이동
             window.open('https://chat.openai.com/g/g-684f6e6b9ed48191bb537979053a36cc-naeireumeun-zavis-sajangnimyi-supeoaeb', '_blank', 'noopener,noreferrer');
             return;
           }
         }
        
        // 3. 로그인되지 않은 경우 안내 메시지 표시 (브라우저별 로그인 안내 포함)
        alert('🔐 로그인이 필요한 서비스입니다!\n\n아래 로그인 버튼을 클릭하여 먼저 로그인해주세요.\n\n📱 참고: 카카오톡, 크롬, 사파리 등 각 브라우저별로 별도 로그인이 필요합니다.\n\n로그인 후 ZAVIS의 모든 기능을 이용하실 수 있습니다.');
        
        // 로그인 버튼으로 시선 유도 (선택사항)
        const authButtons = document.getElementById('authButtons');
        if (authButtons && authButtons.style.display !== 'none') {
          // 로그인 버튼이 보이는 경우 잠깐 강조 효과
          authButtons.style.transform = 'scale(1.05)';
          authButtons.style.transition = 'transform 0.3s ease';
          setTimeout(() => {
            authButtons.style.transform = 'scale(1)';
          }, 300);
        }
        
      } catch (error) {
        // 오류 발생 시 기본 동작 (로그인 안내)
        console.error('로그인 확인 중 오류:', error);
        alert('🔐 로그인이 필요한 서비스입니다!\n\n먼저 로그인해주세요.');
      }
    }
    
    // ============================================================================
    // 로그아웃 버튼 이벤트 리스너
    // ============================================================================
    
    // DOM 로드 완료 후 로그아웃 버튼 이벤트 리스너 등록
    document.addEventListener('DOMContentLoaded', function() {
      // 로그아웃 버튼 요소 선택
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        // 로그아웃 버튼 클릭 이벤트 리스너 등록
        logoutBtn.addEventListener('click', async function() {
          // 로그아웃 확인 대화상자 표시
          if (confirm('정말 로그아웃하시겠습니까?')) {
            try {
              // 로컬 스토리지에서 사용자 정보 삭제
              localStorage.removeItem('zavis-user-info');
              
              // auth.js의 signOut 함수 호출하여 로그아웃 실행
              const result = await signOut();
              
              // UI 업데이트 (페이지 새로고침 대신 직접 업데이트)
              showAuthButtons();                    // 로그인 버튼 표시
              alert('로그아웃되었습니다.');          // 로그아웃 완료 알림
              
            } catch (error) {
              // 로그아웃 처리 중 오류 발생 시 처리
              console.error('로그아웃 처리 오류:', error);
              // 오류 발생 시에도 UI 업데이트 (일관성 유지)
              localStorage.removeItem('zavis-user-info');
              showAuthButtons();
            }
          }
        });
      }
    });
    
    // ============================================================================
    // 추가 브라우저 최적화 설정
    // ============================================================================
    
    // 필요시에만 캐시 제어 메타 태그 추가 (깜빡거림 방지)
    // 개발 환경에서만 사용하고 운영 환경에서는 주석 처리
    if (localStorage.getItem('zavis-dev-mode') === 'true') {
      const meta = document.createElement('meta');                             // 새 메타 태그 생성
      meta.httpEquiv = 'Cache-Control';                                       // HTTP 헤더 설정
      meta.content = 'no-cache, no-store, must-revalidate, max-age=0';       // 캐시 사용 금지
      document.head.appendChild(meta);                                        // 문서 헤드에 추가
    }
  </script>
</body>
</html> 